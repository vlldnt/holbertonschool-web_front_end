<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>

    <meta charset="utf-8" />
    <title>Task 11</title>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous">
        </script>

    <script type="application/javascript">
        function deletePost(id) {
            $.ajax({
                url: `http://localhost:3000/posts/${id}`,
                method: "DELETE"
            }).done(function () {
                $(`#row-${id}`).remove();
            }).fail(function () {
                alert("Post was not deleted")
            });
        }

        function sendForm() {
            $("form").after("<p>About to send the query to the API</p>");
            const data = {
                title: $("#title").val(),
                author: $("#author").val()
            };

            $.ajax({
                url: "http://localhost:3000/posts",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(data)
            }).done(function (res) {
                addPostRow(res);
                $("#title").val("");
                $("#author").val("");
            }).fail(function () {
                alert("Error sending the POST query");
            });
        }

        function buildForm() {
            $("body").append(
                $("<form>")
                    .append(
                        $("<div>").append(
                            $("<label>").attr("for", "author").text("Author")
                        ).append(
                            $("<input>").attr({ type: "text", id: "author", name: "author", required: true })
                        )
                    )
                    .append(
                        $("<div>").append(
                            $("<label>").attr("for", "title").text("Title")
                        ).append(
                            $("<textarea>").attr({ id: "title", name: "title", required: true })
                        )
                    )
                    .append(
                        $("<input>").attr({ type: "submit", value: "Submit" })
                    )
                    .on("submit", function (e) {
                        e.preventDefault();
                        sendForm();
                    })
            );
        }

        function addPostRow(data) {
            $("body").append(
                $(`<p id=row-${data.id}>`).append(
                    $("<span>").text("(delete)").click(
                        function() { 
                            deletePost(data.id)
                        }
                    ),
                    $("<span>").text(`Post created with id ${data.id}, title: ${data.title}, author: ${data.author}`)
                )
            );
        }

        function listPosts() {
            $.get("http://localhost:3000/posts", {}, "json")
                .done(function (json) {
                    console.log(json)
                    $.each(json, function (index, post) {
                        addPostRow(post);
                    })
                }).fail(function () {
                    alert("Server Error")
                });
        }


        $(document).ready(function () {
            listPosts();
            buildForm();
        })
    </script>

</head>

<body>

</body>

</html>